from brownie import *
import json, requests, time, datetime, traceback, math, pprint, base64
from decimal import Decimal
from datetime import datetime

position_abi = json.loads("""[{"inputs": [], "stateMutability": "nonpayable", "type": "constructor"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "owner", "type": "address"}, {"indexed": true, "internalType": "address", "name": "approved", "type": "address"}, {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "Approval", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "owner", "type": "address"}, {"indexed": true, "internalType": "address", "name": "operator", "type": "address"}, {"indexed": false, "internalType": "bool", "name": "approved", "type": "bool"}], "name": "ApprovalForAll", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "user", "type": "address"}, {"indexed": false, "internalType": "address", "name": "closer", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "tokenId", "type": "uint256"}, {"indexed": false, "internalType": "int256", "name": "pnl", "type": "int256"}], "name": "ClosedPosition", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "user", "type": "address"}, {"indexed": true, "internalType": "bool", "name": "isCall", "type": "bool"}, {"indexed": true, "internalType": "uint256", "name": "strike", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "OpenedPosition", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "from", "type": "address"}, {"indexed": true, "internalType": "address", "name": "to", "type": "address"}, {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "Transfer", "type": "event"}, {"inputs": [{"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "approve", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "closePosition", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "getApproved", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getAssetsDue", "outputs": [{"internalType": "uint256", "name": "baseAmount", "type": "uint256"}, {"internalType": "uint256", "name": "quoteAmount", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "getFeesAccumulated", "outputs": [{"internalType": "uint256", "name": "feesAccumulated", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "getFeesAccumulatedAndMin", "outputs": [{"internalType": "uint256", "name": "feesAccumulated", "type": "uint256"}, {"internalType": "uint256", "name": "feesMin", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getOpenStrikesLength", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "isCall", "type": "bool"}, {"internalType": "uint256", "name": "strike", "type": "uint256"}, {"internalType": "uint256", "name": "notionalAmount", "type": "uint256"}, {"internalType": "uint256", "name": "timeToExpirySec", "type": "uint256"}], "name": "getOptionCost", "outputs": [{"internalType": "uint256", "name": "optionCost", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "isCall", "type": "bool"}, {"internalType": "uint256", "name": "strike", "type": "uint256"}, {"internalType": "uint256", "name": "size", "type": "uint256"}, {"internalType": "uint256", "name": "timeToExpirySec", "type": "uint256"}], "name": "getOptionPrice", "outputs": [{"internalType": "uint256", "name": "optionPrice", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getParameters", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint8", "name": "", "type": "uint8"}, {"internalType": "uint8", "name": "", "type": "uint8"}, {"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "getPosition", "outputs": [{"components": [{"internalType": "bool", "name": "isCall", "type": "bool"}, {"internalType": "enum IGoodEntryPositionManager.OptionType", "name": "optionType", "type": "uint8"}, {"internalType": "uint256", "name": "strike", "type": "uint256"}, {"internalType": "uint256", "name": "notionalAmount", "type": "uint256"}, {"internalType": "uint256", "name": "collateralAmount", "type": "uint256"}, {"internalType": "uint256", "name": "startDate", "type": "uint256"}, {"internalType": "uint256", "name": "data", "type": "uint256"}], "internalType": "struct IGoodEntryPositionManager.Position", "name": "", "type": "tuple"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "isCall", "type": "bool"}, {"internalType": "uint256", "name": "addedAmount", "type": "uint256"}], "name": "getUtilizationRate", "outputs": [{"internalType": "uint256", "name": "utilizationRate", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getUtilizationRateStatus", "outputs": [{"internalType": "uint256", "name": "utilizationRate", "type": "uint256"}, {"internalType": "uint256", "name": "maxOI", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "isCall", "type": "bool"}, {"internalType": "uint256", "name": "price", "type": "uint256"}, {"internalType": "uint256", "name": "strike", "type": "uint256"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "getValueAtStrike", "outputs": [{"internalType": "uint256", "name": "vaultDue", "type": "uint256"}, {"internalType": "uint256", "name": "pnl", "type": "uint256"}], "stateMutability": "pure", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}, {"internalType": "uint256", "name": "newCollateralAmount", "type": "uint256"}], "name": "increaseCollateral", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "_oracle", "type": "address"}, {"internalType": "address", "name": "_baseToken", "type": "address"}, {"internalType": "address", "name": "_quoteToken", "type": "address"}, {"internalType": "address", "name": "_vault", "type": "address"}, {"internalType": "address", "name": "_referrals", "type": "address"}], "name": "initProxy", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "operator", "type": "address"}], "name": "isApprovedForAll", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "name", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "isCall", "type": "bool"}, {"internalType": "uint256", "name": "strike", "type": "uint256"}, {"internalType": "uint256", "name": "notionalAmount", "type": "uint256"}, {"internalType": "uint256", "name": "timeToExpiry", "type": "uint256"}], "name": "openFixedPosition", "outputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "openInterestCalls", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "openInterestPuts", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "isCall", "type": "bool"}, {"internalType": "uint256", "name": "notionalAmount", "type": "uint256"}, {"internalType": "uint256", "name": "collateralAmount", "type": "uint256"}], "name": "openStreamingPosition", "outputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "name": "openStrikes", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "ownerOf", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "safeTransferFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "tokenId", "type": "uint256"}, {"internalType": "bytes", "name": "data", "type": "bytes"}], "name": "safeTransferFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "operator", "type": "address"}, {"internalType": "bool", "name": "approved", "type": "bool"}], "name": "setApprovalForAll", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "name": "strikeToOpenInterestCalls", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "name": "strikeToOpenInterestPuts", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bytes4", "name": "interfaceId", "type": "bytes4"}], "name": "supportsInterface", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "symbol", "outputs": [{"internalType": "string", "name": "_symbol", "type": "string"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "index", "type": "uint256"}], "name": "tokenByIndex", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "uint256", "name": "index", "type": "uint256"}], "name": "tokenOfOwnerByIndex", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "tokenURI", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "totalSupply", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "transferFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "vault", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}]""")
vaultAlgebra_abi = json.loads("""[{"inputs": [], "name": "T", "type": "error"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "owner", "type": "address"}, {"indexed": true, "internalType": "address", "name": "spender", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}], "name": "Approval", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "tickerAddress", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "tickerAmount", "type": "uint256"}], "name": "Borrowed", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": false, "internalType": "uint256", "name": "fee0", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "fee1", "type": "uint256"}], "name": "ClaimFees", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "sender", "type": "address"}, {"indexed": true, "internalType": "address", "name": "token", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "liquidity", "type": "uint256"}], "name": "Deposit", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "previousOwner", "type": "address"}, {"indexed": true, "internalType": "address", "name": "newOwner", "type": "address"}], "name": "OwnershipTransferred", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "tickerAddress", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "tickerAmount", "type": "uint256"}], "name": "Repaid", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}], "name": "ReservedFees", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": false, "internalType": "uint8", "name": "ammPositionShareX2", "type": "uint8"}], "name": "SetAmmPositionShare", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": false, "internalType": "uint256", "name": "baseFeeX4", "type": "uint256"}], "name": "SetFee", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": false, "internalType": "uint256", "name": "tvlCapX8", "type": "uint256"}], "name": "SetTvlCap", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "from", "type": "address"}, {"indexed": true, "internalType": "address", "name": "to", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}], "name": "Transfer", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "sender", "type": "address"}, {"indexed": true, "internalType": "address", "name": "token", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "liquidity", "type": "uint256"}], "name": "Withdraw", "type": "event"}, {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "spender", "type": "address"}], "name": "allowance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "ammPositionShareX2", "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "ammType", "outputs": [{"internalType": "bytes32", "name": "_ammType", "type": "bytes32"}], "stateMutability": "pure", "type": "function"}, {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "account", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "baseFeeX4", "outputs": [{"internalType": "uint24", "name": "", "type": "uint24"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "token", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "borrow", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "decimals", "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "subtractedValue", "type": "uint256"}], "name": "decreaseAllowance", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "token", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "deposit", "outputs": [{"internalType": "uint256", "name": "liquidity", "type": "uint256"}], "stateMutability": "payable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "depositBalance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "depositTime", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "increaseBase", "type": "bool"}], "name": "getAdjustedBaseFee", "outputs": [{"internalType": "uint256", "name": "adjustedBaseFeeX4", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getAdjustedReserves", "outputs": [{"internalType": "uint256", "name": "baseAmount", "type": "uint256"}, {"internalType": "uint256", "name": "quoteAmount", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getAmmAmounts", "outputs": [{"internalType": "uint256", "name": "baseAmount", "type": "uint256"}, {"internalType": "uint256", "name": "quoteAmount", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getBasePrice", "outputs": [{"internalType": "uint256", "name": "priceX8", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getLifetimeFees", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "period", "type": "uint256"}], "name": "getPastFees", "outputs": [{"internalType": "uint256", "name": "baseAmount", "type": "uint256"}, {"internalType": "uint256", "name": "quoteAmount", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getPendingFees", "outputs": [{"internalType": "uint256", "name": "pendingFees0", "type": "uint256"}, {"internalType": "uint256", "name": "pendingFees1", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getReserves", "outputs": [{"internalType": "uint256", "name": "baseAmount", "type": "uint256"}, {"internalType": "uint256", "name": "quoteAmount", "type": "uint256"}, {"internalType": "uint256", "name": "valueX8", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "goodEntryCore", "outputs": [{"internalType": "contract IGoodEntryCore", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "addedValue", "type": "uint256"}], "name": "increaseAllowance", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "_baseToken", "type": "address"}, {"internalType": "address", "name": "_quoteToken", "type": "address"}, {"internalType": "address", "name": "_positionManager", "type": "address"}, {"internalType": "address", "name": "weth", "type": "address"}, {"internalType": "address", "name": "_oracle", "type": "address"}], "name": "initProxy", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "name", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "poolPriceMatchesOracle", "outputs": [{"internalType": "bool", "name": "isMatching", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "positionManager", "outputs": [{"internalType": "contract GoodEntryPositionManager", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "token", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}, {"internalType": "uint256", "name": "fees", "type": "uint256"}], "name": "repay", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint8", "name": "_ammPositionShareX2", "type": "uint8"}], "name": "setAmmPositionShare", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint24", "name": "_baseFeeX4", "type": "uint24"}], "name": "setBaseFee", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint96", "name": "_tvlCapX8", "type": "uint96"}], "name": "setTvlCap", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "intentAmount", "type": "uint256"}], "name": "setWithdrawalIntent", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "symbol", "outputs": [{"internalType": "string", "name": "_symbol", "type": "string"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "tokens", "outputs": [{"internalType": "address", "name": "", "type": "address"}, {"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "totalIntents", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "totalSupply", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "transfer", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "transferFrom", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "newOwner", "type": "address"}], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "tvlCapX8", "outputs": [{"internalType": "uint96", "name": "", "type": "uint96"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "liquidity", "type": "uint256"}, {"internalType": "address", "name": "token", "type": "address"}], "name": "withdraw", "outputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "onBehalfOf", "type": "address"}, {"internalType": "uint256", "name": "liquidity", "type": "uint256"}, {"internalType": "address", "name": "token", "type": "address"}], "name": "withdrawOnBehalf", "outputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "withdrawalIntents", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"stateMutability": "payable", "type": "receive"}]""")
multicall_abi = json.loads("""[{"inputs": [{"components": [{"internalType": "address", "name": "target", "type": "address"}, {"internalType": "bytes", "name": "callData", "type": "bytes"}], "internalType": "struct Multicall2.Call[]", "name": "calls", "type": "tuple[]"}], "name": "aggregate", "outputs": [{"internalType": "uint256", "name": "blockNumber", "type": "uint256"}, {"internalType": "bytes[]", "name": "returnData", "type": "bytes[]"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"components": [{"internalType": "address", "name": "target", "type": "address"}, {"internalType": "bytes", "name": "callData", "type": "bytes"}], "internalType": "struct Multicall2.Call[]", "name": "calls", "type": "tuple[]"}], "name": "blockAndAggregate", "outputs": [{"internalType": "uint256", "name": "blockNumber", "type": "uint256"}, {"internalType": "bytes32", "name": "blockHash", "type": "bytes32"}, {"components": [{"internalType": "bool", "name": "success", "type": "bool"}, {"internalType": "bytes", "name": "returnData", "type": "bytes"}], "internalType": "struct Multicall2.Result[]", "name": "returnData", "type": "tuple[]"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "blockNumber", "type": "uint256"}], "name": "getBlockHash", "outputs": [{"internalType": "bytes32", "name": "blockHash", "type": "bytes32"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getBlockNumber", "outputs": [{"internalType": "uint256", "name": "blockNumber", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getCurrentBlockCoinbase", "outputs": [{"internalType": "address", "name": "coinbase", "type": "address"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getCurrentBlockDifficulty", "outputs": [{"internalType": "uint256", "name": "difficulty", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getCurrentBlockGasLimit", "outputs": [{"internalType": "uint256", "name": "gaslimit", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getCurrentBlockTimestamp", "outputs": [{"internalType": "uint256", "name": "timestamp", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "addr", "type": "address"}], "name": "getEthBalance", "outputs": [{"internalType": "uint256", "name": "balance", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getL1BlockNumber", "outputs": [{"internalType": "uint256", "name": "l1BlockNumber", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "getLastBlockHash", "outputs": [{"internalType": "bytes32", "name": "blockHash", "type": "bytes32"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "requireSuccess", "type": "bool"}, {"components": [{"internalType": "address", "name": "target", "type": "address"}, {"internalType": "bytes", "name": "callData", "type": "bytes"}], "internalType": "struct Multicall2.Call[]", "name": "calls", "type": "tuple[]"}], "name": "tryAggregate", "outputs": [{"components": [{"internalType": "bool", "name": "success", "type": "bool"}, {"internalType": "bytes", "name": "returnData", "type": "bytes"}], "internalType": "struct Multicall2.Result[]", "name": "returnData", "type": "tuple[]"}], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "bool", "name": "requireSuccess", "type": "bool"}, {"components": [{"internalType": "address", "name": "target", "type": "address"}, {"internalType": "bytes", "name": "callData", "type": "bytes"}], "internalType": "struct Multicall2.Call[]", "name": "calls", "type": "tuple[]"}], "name": "tryBlockAndAggregate", "outputs": [{"internalType": "uint256", "name": "blockNumber", "type": "uint256"}, {"internalType": "bytes32", "name": "blockHash", "type": "bytes32"}, {"components": [{"internalType": "bool", "name": "success", "type": "bool"}, {"internalType": "bytes", "name": "returnData", "type": "bytes"}], "internalType": "struct Multicall2.Result[]", "name": "returnData", "type": "tuple[]"}], "stateMutability": "nonpayable", "type": "function"}]""")
lpVault_abi = json.loads("""[{"inputs":[{"internalType":"address","name":"_stakedToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Claimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Staked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Unstaked","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PRECISION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claim","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"claimableRewardsOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"cumulativeRewardPerToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pendingRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"streamer_","type":"address"}],"name":"setStreamer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_account","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"stakedToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"streamer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_account","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"updateRewards","outputs":[],"stateMutability":"nonpayable","type":"function"}]""") 
oracle_abi = json.loads("""[{"inputs":[{"internalType":"address[]","name":"assets","type":"address[]"},{"internalType":"address[]","name":"sources","type":"address[]"},{"internalType":"address","name":"fallbackOracle","type":"address"},{"internalType":"address","name":"baseCurrency","type":"address"},{"internalType":"uint256","name":"baseCurrencyUnit","type":"uint256"},{"internalType":"int256","name":"riskFreeRate","type":"int256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"asset","type":"address"},{"indexed":true,"internalType":"address","name":"source","type":"address"}],"name":"AssetSourceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"baseCurrency","type":"address"},{"indexed":false,"internalType":"uint256","name":"baseCurrencyUnit","type":"uint256"}],"name":"BaseCurrencySet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"fallbackOracle","type":"address"}],"name":"FallbackOracleUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"ivMultiplier","type":"uint16"}],"name":"IVMultiplierUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"int256","name":"riskFreeRate","type":"int256"}],"name":"RiskFreeRateUpdated","type":"event"},{"inputs":[],"name":"ADDRESSES_PROVIDER","outputs":[{"internalType":"contract IPoolAddressesProvider","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"BASE_CURRENCY","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"BASE_CURRENCY_UNIT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"asset","type":"address"},{"internalType":"uint8","name":"length","type":"uint8"}],"name":"_volatility","outputs":[{"internalType":"uint224","name":"volatility","type":"uint224"},{"internalType":"uint8","name":"realLength","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"baseToken","type":"address"},{"internalType":"uint256","name":"utilizationRate","type":"uint256"}],"name":"getAdjustedVolatility","outputs":[{"internalType":"uint256","name":"volatility","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"asset","type":"address"}],"name":"getAssetPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"asset","type":"address"},{"internalType":"uint256","name":"thatDay","type":"uint256"}],"name":"getAssetPriceAtDay","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"asset","type":"address"},{"internalType":"uint8","name":"length","type":"uint8"}],"name":"getAssetVolatility","outputs":[{"internalType":"uint224","name":"volatility","type":"uint224"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"assets","type":"address[]"}],"name":"getAssetsPrices","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getFallbackOracle","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getIVMultiplier","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bool","name":"isCall","type":"bool"},{"internalType":"address","name":"baseToken","type":"address"},{"internalType":"address","name":"quoteToken","type":"address"},{"internalType":"uint256","name":"strike","type":"uint256"},{"internalType":"uint256","name":"timeToExpirySec","type":"uint256"},{"internalType":"uint256","name":"utilizationRate","type":"uint256"}],"name":"getOptionPrice","outputs":[{"internalType":"uint256","name":"optionPrice","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bool","name":"isCall","type":"bool"},{"internalType":"address","name":"baseToken","type":"address"},{"internalType":"address","name":"quoteToken","type":"address"},{"internalType":"uint256","name":"strike","type":"uint256"},{"internalType":"uint256","name":"timeToExpirySec","type":"uint256"},{"internalType":"uint256","name":"volatility","type":"uint256"},{"internalType":"uint256","name":"utilizationRate","type":"uint256"}],"name":"getOptionPrice","outputs":[{"internalType":"uint256","name":"callPrice","type":"uint256"},{"internalType":"uint256","name":"putPrice","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getRiskFreeRate","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"asset","type":"address"}],"name":"getSourceOfAsset","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"assets","type":"address[]"},{"internalType":"address[]","name":"sources","type":"address[]"},{"internalType":"address","name":"baseCurrency","type":"address"},{"internalType":"uint256","name":"baseCurrencyUnit","type":"uint256"},{"internalType":"int256","name":"riskFreeRate","type":"int256"}],"name":"initializer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"assets","type":"address[]"},{"internalType":"address[]","name":"sources","type":"address[]"}],"name":"setAssetSources","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"fallbackOracle","type":"address"}],"name":"setFallbackOracle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"ivMultiplierX2","type":"uint16"}],"name":"setIVMultiplier","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"int256","name":"riskFreeRate","type":"int256"}],"name":"setRiskFreeRate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"assets","type":"address[]"}],"name":"snapshotDailyAssetsPrices","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}]""")

user = "0xd2DE083018d93C6a7c4FB154Bf6F36E6F1833796"
multicall = Contract.from_abi(address="0x842eC2c7D803033Edf55E478F461FC547Bc54EB2", abi=multicall_abi, name="Multicall")
geWeth1 = Contract.from_abi(address="0x8c037eF65e1B3d2094AC75c301e2b1e6eA7e3D67", abi=position_abi, name="WETH_USDC.e") # WETH_USDC.e
geWeth2 = Contract.from_abi(address="0x0f652aAd7993D48bd6E876829aEDC068507a6cE3", abi=position_abi, name="WETH_USDC") # WETH_USDC 
geWethLP1 = Contract.from_abi(address="0xd666156C473Cc9539CAaCc112B3A3590a895C861", abi=vaultAlgebra_abi, name="WETH_USDC.e Vault")
geWethLP2 = Contract.from_abi(address="0x36003A975bFC56f650590C26B1479ba423217931", abi=vaultAlgebra_abi, name="WETH_USDC Vault")
geWbtc   = Contract.from_abi(address="0xb7c602973c61ed1fdb6f759559b217af42066902", abi=position_abi, name="WBTC_USDC") # WBTC_USDC 
geWbtcLP = Contract.from_abi(address="0x5f6aB9b043C43FaB8D2A51EA85b70495B5EeFD15", abi=vaultAlgebra_abi, name="WBTC_USDC Vault") #WBTC_USDC
geWethLP1_vault = Contract.from_abi(address="0x6FE937844dCFd8A001F163eC490241c6f5202d25", abi=lpVault_abi, name="WETH_USDC Reward Tracker")
oracle = Contract.from_abi(address="0x4A9EB72b72cB6fBbD8eF8C83342f252e519559e9", abi=oracle_abi, name="GoodEntry Oracle")
weth = "0x82af49447d8a07e3bd95bd0d56f35241523fbab1"
wbtc = "0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f"

def getOpenPositions(): # Multicall version
    # Stage 1: Get exposure and position sizes
    calls_stage1 = [    
        [geWethLP1.address, geWethLP1.getReserves.encode_input()],
        [geWethLP2.address, geWethLP2.getReserves.encode_input()],
        [geWethLP1.address, geWethLP1.getAmmAmounts.encode_input()],
        [geWethLP2.address, geWethLP2.getAmmAmounts.encode_input()],
        [geWethLP1.address, geWethLP1.balanceOf.encode_input(user)],
        [geWethLP1.address, geWethLP1.totalSupply.encode_input()],
        [geWethLP2.address, geWethLP2.balanceOf.encode_input(user)],
        [geWethLP2.address, geWethLP2.totalSupply.encode_input()],
        [geWbtcLP.address, geWbtcLP.getReserves.encode_input()],
        [geWbtcLP.address, geWbtcLP.getAmmAmounts.encode_input()],
        [geWbtcLP.address, geWbtcLP.balanceOf.encode_input(user)],
        [geWbtcLP.address, geWbtcLP.totalSupply.encode_input()],
        
        [geWethLP1.address, geWethLP1.getPendingFees.encode_input()],
        [geWethLP2.address, geWethLP1.getPendingFees.encode_input()],
        [geWbtcLP.address , geWethLP1.getPendingFees.encode_input()],
        
        [geWeth1.address,   geWeth1.totalSupply.encode_input()],
        [geWeth2.address,   geWeth2.totalSupply.encode_input()], 
        [geWbtc.address,    geWbtc.totalSupply.encode_input()],
                
        
        [geWethLP1_vault,   geWethLP1_vault.balanceOf.encode_input(user)],
        [oracle,            oracle.getAssetPrice.encode_input(weth)],
        [oracle,            oracle.getAssetPrice.encode_input(wbtc)],
        
        
    ]
    responses = responses_stage1 = multicall.aggregate.call(calls_stage1)[1]
    # Decode the outputs for ETH
    reserves1 = geWethLP1.getReserves.decode_output(responses[0])
    reserves2 = geWethLP2.getReserves.decode_output(responses[1])
    ammAmounts1 = geWethLP1.getAmmAmounts.decode_output(responses[2])
    ammAmounts2 = geWethLP2.getAmmAmounts.decode_output(responses[3])
    userBalance1 = geWethLP1.balanceOf.decode_output(responses[4])
    totalSupply1 = geWethLP1.totalSupply.decode_output(responses[5])
    userBalance2 = geWethLP2.balanceOf.decode_output(responses[6])
    totalSupply2 = geWethLP2.totalSupply.decode_output(responses[7])
    
    # Decoding for geWbtcLP
    reserves_wbtc = geWbtcLP.getReserves.decode_output(responses[8])
    ammAmounts_wbtc = geWbtcLP.getAmmAmounts.decode_output(responses[9])
    userBalance_wbtc = geWbtcLP.balanceOf.decode_output(responses[10])
    totalSupply_wbtc = geWbtcLP.totalSupply.decode_output(responses[11])
    
    pendingFees_lp1 = geWethLP1.getPendingFees.decode_output(responses[12])
    pendingFees_lp2 = geWethLP1.getPendingFees.decode_output(responses[13])
    pendingFees_btc = geWethLP1.getPendingFees.decode_output(responses[14])
        
    # Decoding for Reward Tracker vaults
    userBalance1 += geWethLP1_vault.balanceOf.decode_output(responses[18])
    
    # Decoding oracle price for WETH and WBTC
    weth_price = oracle.getAssetPrice.decode_output(responses[19])
    wbtc_price = oracle.getAssetPrice.decode_output(responses[20])
        
    proportion = {"LP1": userBalance1 / totalSupply1, "LP2": userBalance2 / totalSupply2, "LPBTC": userBalance_wbtc / totalSupply_wbtc}
    # Return a structured result of exposure details
    exposure = {
        "reserves1": reserves1,
        "reserves2": reserves2,
        "ammAmounts1": ammAmounts1,
        "ammAmounts2": ammAmounts2,
        "userBalance1": userBalance1,
        "totalSupply1": totalSupply1,
        "userBalance2": userBalance2,
        "totalSupply2": totalSupply2,
        # Additional structure for geWbtcLP
        "reserves_wbtc": reserves_wbtc,
        "ammAmounts_wbtc": ammAmounts_wbtc,
        "userBalance_wbtc": userBalance_wbtc,
        "totalSupply_wbtc": totalSupply_wbtc,
        "userReserves_weth": reserves1[0] * proportion["LP1"] + reserves2[0] * proportion["LP2"],
        "userReserves_wbtc": reserves_wbtc[0] * proportion["LPBTC"],
        "userReserves_usdc": reserves1[1] * proportion["LP1"] + reserves2[1] * proportion["LP2"] + reserves_wbtc[1] * proportion["LPBTC"] ,
        
        "userPendingFees_weth": pendingFees_lp1[0] * proportion["LP1"] + pendingFees_lp2[0] * proportion["LP2"],
        "userPendingFees_wbtc": pendingFees_btc[0] * proportion["LPBTC"],
        "userPendingFees_usdc": pendingFees_lp1[1] * proportion["LP1"] + pendingFees_lp2[1] * proportion["LP2"] + pendingFees_btc[1] * proportion["LPBTC"] ,
        
        "proportion": proportion
    }
    # 
    total_supply_1   = geWeth1.totalSupply.decode_output(responses_stage1[15])
    total_supply_2   = geWeth2.totalSupply.decode_output(responses_stage1[16])
    total_supply_btc = geWbtc.totalSupply.decode_output(responses_stage1[17])
    
    # Stage 2: Get tokens by index
    calls_stage2 = []
    for i in range(total_supply_1):
        calls_stage2.append([geWeth1.address, geWeth1.tokenByIndex.encode_input(i)])
    for i in range(total_supply_2):
        calls_stage2.append([geWeth2.address, geWeth2.tokenByIndex.encode_input(i)])
    for i in range(total_supply_btc):
        calls_stage2.append([geWbtc.address, geWbtc.tokenByIndex.encode_input(i)])
    
    responses_stage2 = multicall.aggregate.call(calls_stage2)[1]
    token_indices_1 = [geWeth1.tokenByIndex.decode_output(res) for res in responses_stage2[:total_supply_1]]
    token_indices_2 = [geWeth2.tokenByIndex.decode_output(res) for res in responses_stage2[total_supply_1:total_supply_1+total_supply_2]]
    token_indices_3 = [geWbtc.tokenByIndex.decode_output(res)  for res in responses_stage2[total_supply_1+total_supply_2:]]
    
    # Stage 3: Get position data and accumulated fees
    calls_stage3 = []
    for token_index in token_indices_1:
        calls_stage3.append([geWeth1.address, geWeth1.getPosition.encode_input(token_index)])
        calls_stage3.append([geWeth1.address, geWeth1.getFeesAccumulatedAndMin.encode_input(token_index)])
    for token_index in token_indices_2:
        calls_stage3.append([geWeth2.address, geWeth2.getPosition.encode_input(token_index)])
        calls_stage3.append([geWeth2.address, geWeth2.getFeesAccumulatedAndMin.encode_input(token_index)])
    for token_index in token_indices_3:
        calls_stage3.append([geWbtc.address, geWbtc.getPosition.encode_input(token_index)])
        calls_stage3.append([geWbtc.address, geWbtc.getFeesAccumulatedAndMin.encode_input(token_index)])
    
    responses_stage3 = multicall.aggregate.call(calls_stage3)[1]
    
    # Process and print the position data
    open_positions = []
    for i in range(0, len(responses_stage3), 2):
        if i < total_supply_1 * 2:
            name, lp, dec, address = "WETH-USDC.e", "LP1", 1e18, geWeth1.address
        elif i < (total_supply_1 + total_supply_2) * 2:
            name, lp, dec, address = "WETH-USDC", "LP2", 1e18, geWeth2.address
        else:
            name, lp, dec, address = "BTC-USDC", "LPBTC", 1e8, geWbtc.address
        
        pos = geWeth1.getPosition.decode_output(responses_stage3[i])
        fees_acc = max(geWeth1.getFeesAccumulatedAndMin.decode_output(responses_stage3[i+1]))
        
        position_data = {
            "address": address,
            "type": "C" if pos[0] else "P",
            "strike": pos[2] / 1e8,
            "oracle": weth_price / 1e8 if name[0:4] == "WETH" else wbtc_price / 1e8,
            "notional_value": pos[3] / ((dec * 1e8) / pos[2] if pos[0] else 1e6),
            "collateral_value": pos[4] / 1e6,
            "expiry": datetime.fromtimestamp(pos[5] + pos[4] * 1e10 / pos[6]),
            "description": f"{name} - {'Call' if pos[0] else 'Put'} - Strike {pos[2] / 1e8} - Notional ${pos[3] / ((dec * 1e8) / pos[2] if pos[0] else 1e6)}",
            'lp': lp,
            'earned': fees_acc / 1e6,
            'theta': pos[6] / 1e10 / 1e6,
            'start_ts': pos[5],
            'end_ts': pos[5] + pos[4] * 1e10 / pos[6],
            'spot_price': None
        }
        open_positions.append(position_data)
    
    return [open_positions, exposure]

def main():
    # Call the function to retrieve open positions and exposure data
    open_positions, exposure = getOpenPositions()
    
    # Show user exposure - This should be your account with the LP positions to figure out your exposure
    print("User Exposure: ")
    pprint.pprint(exposure)
    print
    print
    print
    # Show open positions
    print("Open Positions: ")
    for position in open_positions:
        pprint.pprint(position)
    
    
